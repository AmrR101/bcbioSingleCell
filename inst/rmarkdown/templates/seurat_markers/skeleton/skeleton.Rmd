---
title: "Seurat Markers"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
params:
    seuratFile: "data/bcb_filtered_seurat.rda"
    markersFile: "meta/markers.xlsx"
    outputDir: "."
---

```{r setup, cache=FALSE, message=FALSE, warning=FALSE}
library(bcbioSingleCell)

# Shared RMarkdown settings
prepareSingleCellTemplate()
if (file.exists("setup.R")) {
    source("setup.R")
}

# Load seurat object
seuratName <- basename(params$seuratFile) %>%
    # Remove file extension, if specified
    str_replace("\\.[A-Za-z0-9]+", "")
loadDataAsName(c(seurat = params$seuratFile))

# Check to see if we need to process markers
markersName <- paste(seuratName, "markers", sep = "_")
markersFile <- file.path("data", paste0(markersName, ".rda"))
if (file.exists(markersFile)) {
    loadDataAsName(c(markers = markersFile))
    evalMarkers <- FALSE
} else {
    evalMarkers <- TRUE
}

# Directory paths
markersDir <- file.path(params$outputDir, "results", "markers")
dir.create(markersDir, recursive = TRUE, showWarnings = FALSE)
```

```{r header, child="_header.Rmd", eval=file.exists("_header.Rmd")}
```

```{r sample_metadata}
sampleMetadata(seurat, kable = TRUE)
```



This workflow is adapted from the following sources:

- Satija Lab: [Seurat v2 Guided Clustering Tutorial](http://satijalab.org/seurat/pbmc3k_tutorial.html)



* * *



Seurat can help you find markers that define clusters via differential expression. By default, it identifes positive and negative markers of a single cluster (specified in `ident.1`), compared to all other cells. `FindAllMarkers()` automates this process for all clusters, but you can also test groups of clusters vs. each other, or against all cells.

The `min.pct` argument requires a gene to be detected at a minimum percentage in either of the two groups of cells, and the `thresh.test` argument requires a gene to be differentially expressed (on average) by some amount between the two groups. You can set both of these to 0, but with a dramatic increase in time - since this will test a large number of genes that are unlikely to be highly discriminatory. As another option to speed up these computations, `max.cells.per.ident` can be set. This will downsample each identity class to have no more cells than whatever this is set to. While there is generally going to be a loss in power, the speed increases can be significiant and the most highly differentially expressed genes will likely still rise to the top.

Seurat has four tests for differential expression which can be set with the `test.use` parameter: LRT test based on zero-inflated data (`bimod`, default), ROC test (`roc`), t-test (`t`), LRT test based on tobit-censoring models (`tobit`) The ROC test returns the 'classification power' for any individual marker (ranging from 0 - random, to 1 - perfect).

```{r find_all_markers, results="hide", eval=evalMarkers}
markers <- FindAllMarkers(seurat)
assignAndSaveData(
    paste(markersName, "original", sep = "_"),
    markers)

# Use this data frame to convert the gene symbols ("gene" column) back to
# Ensembl gene identifiers ("ensgene" column)
g2s <- data.frame(
    ensgene = names(rownames(seurat@raw.data)),
    symbol = rownames(seurat@raw.data))

# The `detectOrganism()` step may error if a FASTA spike-in (e.g. EGFP) is the
# first row of the seurat count matrix
organism <- rownames(g2s)[[1]] %>%
    detectOrganism
anno <- annotable(organism) %>%
    # Drop the symbols â€” use the ones stored in seurat instead. Otherwise
    # when we join the markers and anno data.frames, there will be a mismatch
    # between the symbol columns.
    tidy_select(-symbol)

markers <- markers %>%
    # The rownames of the markers data.frame will have numbers to the end of the
    # gene symbol. Be sure to drop the rownames here and map the Ensembl gene
    # identifiers to the symbols ("gene" column) instead.
    remove_rownames %>%
    as("tibble") %>%
    camel %>%
    rename(symbol = gene,
           pvalue = pVal) %>%
    left_join(g2s, by = "symbol") %>%
    # We'll lose annotations if we attempt to map by symbol (see above)
    left_join(anno, by = "ensgene") %>%
    tidy_select(cluster, ensgene, symbol, everything()) %>%
    group_by(cluster) %>%
    arrange(pvalue, .by_group = TRUE)

# Save the markers
assignAndSaveData(markersName, markers)
write_csv(markers, file.path(markersDir, paste0(markersName, ".csv.gz")))
```



# Top markers per cluster {.tabset}

```{r top_markers, results="asis"}
topMarkers <- topMarkers(markers, show = TRUE)
```

```{r plot_top_markers, results="asis"}
plotTopMarkers(seurat, topMarkers, headerLevel = 2, combine = TRUE)
```



# Cluster heterogeneity

Heatmaps can also be a good way to examine heterogeneity within/between clusters. The `DoHeatmap()` function will generate a heatmap for given cells and genes. In this case, we are plotting the top markers for each cluster.

```{r do_heatmap}
DoHeatmap(
    seurat,
    genes.use = topMarkers$symbol,
    col.low = viridis(3)[[1]],
    col.mid = viridis(3)[[2]],
    col.high = viridis(3)[[3]],
    remove.key = FALSE,
    rotate.key = TRUE,
    slim.col.label = TRUE)
```



# Known marker analysis

```{r known_markers, results="asis"}
knownMarkers <- readMarkers(
    params$markersFile,
    gene2symbol = gene2symbol,
    show = TRUE)
saveData(knownMarkers)
```


## Known markers detected

Let's obtain the statistics on our known marker genes from [Seurat][].

```{r known_markers_detected, results="asis"}
knownMarkersDetected <- knownMarkersDetected(markers, knownMarkers, show = TRUE)
```


## Known markers by cell type {.tabset}

```{r plot_known_markers, results="asis"}
plotKnownMarkers(seurat, knownMarkersDetected, headerLevel = 3)
```



```{r footer, child="_footer.Rmd", eval=file.exists("_footer.Rmd")}
```
