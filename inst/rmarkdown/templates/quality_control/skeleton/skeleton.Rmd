---
title: "Quality Control"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
params:
    bcb_file: "bcb.rda"
    min_umis: 1000
    max_umis: !r Inf
    min_genes: 500
    max_genes: !r Inf
    max_mito_ratio: 0.1
    min_novelty: 0.75
    min_cells_per_gene: 3
    data_dir: "."
---

```{r setup, cache=FALSE, message=FALSE}
# Last modified 2018-05-01
bcbioSingleCell::prepareSingleCellTemplate()
source("_setup.R")

# Load bcbioSingleCell object
bcb_name <- load(params$bcb_file)
bcb <- get(bcb_name, inherits = FALSE)
stopifnot(is(bcb, "bcbioSingleCell"))
invisible(validObject(bcb))
```

```{r header, child="_header.Rmd"}
```



```{r sample_data}
sampleData(bcb, return = "data.frame")
```

[bcbio][] run data was imported from **`r metadata(bcb)$uploadDir`**.



# Quality control metrics

## Reads per cell {.tabset}

These are counts of how many reads are assigned to a given cellular barcode. It is normal for single cell RNA-seq data to contain a large number of low complexity barcodes. The bcbio pipeline filters out most of these barcodes, and here we have applied a threshold cutoff of a minimum of `r metadata(bcb)$cellularBarcodeCutoff` reads per cell. The unfiltered read count distributions are shown here.

### Ridgeline

With a ridgeline plot, we can easily determine that there are a lot of low complexity barcodes in this dataset that need to be removed prior to clustering. You can see in this plot that the majorify of cellular barcodes from the `r metadata(bcb)$umiType` platform have a low read depth.

```{r plot_reads_per_cell_ridgeline}
plotReadsPerCell(bcb, geom = "ridgeline")
```

### ECDF

Similarly, an empirical distribution function (ECDF) plot will show the frequency distribution of the reads per cell. You can see that the vast majority of low complexity barcodes plateau at a read depth below 1000 reads per cell.

```{r plot_reads_per_cell_ecdf}
plotReadsPerCell(bcb, geom = "ecdf", interestingGroups = "sampleName")
```

### Histogram

For high quality data, the proportional histogram should contain a single large peak that represents cells that were encapsulated. If we see a strong shoulder, or a bimodal distribution of the cells, that can indicate a couple problems. It might be that there is free floating RNA, which happens when cells are dying. It could also be that there are a set of cells that failed for some reason. Finally, it could also be that there are biologically different types of cells, and one type is much smaller than the other. If this is the case we would expect to see less RNA being sequenced from the smaller cells.

It looks like there a lot of low complexity barcodes that need to be filtered out, but we can see cells with a usable read depth of at least 10,000 (10^4) reads per cell.

```{r plot_reads_per_cell_histogram}
plotReadsPerCell(bcb, geom = "histogram", interestingGroups = "sampleName")
```


## UMI counts per cell {.tabset}

Now let's assess the distribution of unique molecular identifier (UMI)-deconvoluted counts per cell. We can see across all samples that most low complexity barcodes fall below 1000 UMIs per cell.

A somewhat similar distribution is observed for all samples, but there does appear to be enough per sample variation to possibly warrant individual UMI cutoff values.

Here's the knee points calculated per sample (see legend):

```{r plot_umis_per_cell_knee_per_sample}
plotUMIsPerCell(
    bcb,
    geom = "ecdf",
    interestingGroups = "sampleName",
    barcodeRanks = TRUE,
    ranksPerSample = TRUE,
    labelPoint = "knee"
)
```

The per sample cutoffs might be a bit too aggressive (e.g. UC6H), so I'm going to try initial filtering and clustering using the knee point calculated across all samples.


## UMI filtering

Let's apply this step first and then proceed to evaluating gene detection, mitocondrial transcript abundance, and novelty scores.

```{r filter_umi}
knee <- as.integer(barcodeRanks(bcb)[["knee"]])
print(knee)

bcb <- filterCells(
    object = bcb,
    minUMIs = knee,
    maxUMIs = Inf,
    minGenes = 0,
    maxGenes = Inf,
    maxMitoRatio = Inf,
    minNovelty = 0,
    minCellsPerGene = 0
)
```


## Genes detected per cell {.tabset}

Here by "detected", we mean genes with a non-zero count measurement per cell. Seeing gene detection in the range of `500`-`5000` is normal for most single-cell experiments.

```{r plot_genes_per_cell}
markdownHeader("histogram", level = 3)
plotGenesPerCell(
    bcb,
    geom = "histogram",
    min = min(params$min_genes),
    max = max(params$max_genes)
)

markdownHeader("violin", level = 3)
plotGenesPerCell(
    bcb,
    geom = "violin",
    min = min(params$min_genes),
    max = max(params$max_genes)
)

markdownHeader("boxplot", level = 3)
plotGenesPerCell(
    bcb,
    geom = "boxplot",
    min = min(params$min_genes),
    max = max(params$max_genes)
)
```


## UMIs vs. genes detected

If we graph out the total number of UMI counts per cell vs. the genes detected per cell, we can assess whether there is a large population of low quality cells with low counts and/or gene detection.

```{r plot_umis_vs_genes}
plotUMIsVsGenes(bcb)
```


## Mitochondrial counts ratio {.tabset}

We evaluate overall mitochondrial gene expression as a biomarker of cellular stress during sample preparation.

```{r plot_mito_ratio}
markdownHeader("histogram", level = 3)
plotMitoRatio(
    bcb,
    geom = "histogram",
    max = max(params$max_mito_ratio)
)

markdownHeader("violin", level = 3)
plotMitoRatio(
    bcb,
    geom = "violin",
    max = max(params$max_mito_ratio)
)

markdownHeader("boxplot", level = 3)
plotMitoRatio(
    bcb,
    geom = "boxplot",
    max = max(params$max_mito_ratio)
)
```


## Novelty {.tabset}

Another way to QC the data is to look for less novelty, that is cells that have less genes detected per count than other cells. We can see the samples where we sequenced each cell less have a higher overall novelty, that is because we have not started saturated the sequencing for any given gene for these samples. Outlier cells in these samples might be cells that we have a less complex RNA species than other cells. Sometimes we can detect contamination with low complexity cell types like red blood cells via this metric.

```{r plot_novelty}
markdownHeader("histogram", level = 3)
plotNovelty(
    bcb,
    geom = "histogram",
    min = min(params$min_novelty)
)

markdownHeader("violin", level = 3)
plotNovelty(
    bcb,
    geom = "violin",
    min = min(params$min_novelty)
)

markdownHeader("boxplot", level = 3)
plotNovelty(
    bcb,
    geom = "boxplot",
    min = min(params$min_novelty)
)
```



# Filter cells

```{r filter_cells}
bcb_filtered <- filterCells(
    bcb,
    minUMIs = params$min_umis,
    maxUMIs = params$max_umis,
    minGenes = params$min_genes,
    maxGenes = params$max_genes,
    maxMitoRatio = params$max_mito_ratio,
    minNovelty = params$min_novelty,
    minCellsPerGene = params$min_cells_per_gene)
assignAndSaveData(
    name = paste(bcb_name, "filtered", sep = "_"),
    object = bcb_filtered,
    dir = params$data_dir
)
```

```{r plot_filtered_qc}
plotQC(
    bcb_filtered,
    geom = "violin",
    return = "markdown",
    headerLevel = 2
)
```



```{r footer, child="_footer.Rmd"}
```
