#' Known Markers Detected
#'
#' @rdname knownMarkersDetected
#' @name knownMarkersDetected
#' @family Clustering Utilities
#' @author Michael Steinbaugh
#'
#' @inheritParams AllGenerics
#'
#' @param all [Seurat::FindAllMarkers()] return.
#' @param known Known markers [data.frame] imported by [readMarkers()] or
#'   pulled from internal [cellCycleMarkers] data.
#' @param removePromiscuous Remove markers with very poor specificity, which are
#'   present in at least 5 clusters.
#'
#' @return [tibble].
NULL



# Constructors ====
#' Known Markers Detected
#'
#' @importFrom dplyr everything filter group_by left_join n pull select
#'   summarize
#' @importFrom rlang !! !!! sym syms
#'
#' @param all All markers, generated by [Seurat::FindAllMarkers()] return.
#' @param known Known markers Excel input or internal [cellTypeMarkers].
#'
#' @note Both the `all` and `known` objects must contain Ensembl gene
#'   identifiers in the `ensgene` column. We must avoid any matching operations
#'   based on the gene symbols, since these change often and can mismatch
#'   easily.
#'
#' @return [grouped_df].
#' @noRd
.knownMarkersDetected <- function(
    all,
    known,
    removePromiscuous = FALSE) {
    .validMarkers(all)
    # Check for `ensgene` column in both `all` and `known`
    if (!"ensgene" %in% colnames(all) & "ensgene" %in% colnames(known)) {
        stop("'all' and 'known' objects must contain 'ensgene' column",
             call. = FALSE)
    }
    # Check for `ensgene` overlap; avoid accidental organism mismatch
    if (!any(known[["ensgene"]] %in% all[["ensgene"]])) {
        stop("No 'ensgene' intersect between 'all' and 'known'",
             call. = FALSE)
    }
    markers <- all %>%
        left_join(known[, c("cell", "ensgene")], by = "ensgene") %>%
        select(c("cell", "ensgene", "symbol", "cluster"), everything()) %>%
        filter(!is.na(.data[["cell"]])) %>%
        .[order(.[["cell"]], .[["symbol"]], .[["pvalue"]], .[["avgDiff"]],
                decreasing = c(FALSE, FALSE, FALSE, TRUE)), , drop = FALSE] %>%
        group_by(!!sym("cell"))
    if (isTRUE(removePromiscuous)) {
        # Filter out promiscuous markers present in at least 5 clusters
        promiscuous <- markers %>%
            group_by(!!!syms(c("cell", "ensgene", "symbol"))) %>%
            summarize(n = n()) %>%
            filter(n >= 5) %>%
            pull("ensgene")
        warning(paste(
            "Promiscuous markers:",
            toString(promiscuous)),
            call. = FALSE)
    }
    markers
}



# Methods ====
#' @rdname knownMarkersDetected
#' @export
setMethod(
    "knownMarkersDetected",
    signature(all = "grouped_df",
              known = "tbl_df"),
    .knownMarkersDetected)
