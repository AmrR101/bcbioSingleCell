# TODO Need to recode around import of sparse counts instead of tximport...

#' Package scRNA-Seq counts into [SummarizedExperiment]
#'
#' Contains counts generated by [tximport()], along with
#' [bcbio-nextgen](https://bcbio-nextgen.readthedocs.io/) run metadata.
#'
#' @rdname summarized_experiment
#' @keywords internal
#'
#' @author Michael Steinbaugh
#'
#' @param sparse_counts Gene-level sparse counts matrix.
#' @param col_data Cellular barcode metrics.
#' @param row_data [Ensembl](http://www.ensembl.org/) gene annotations.
#' @param metadata Custom metadata.
#'
#' @return [SummarizedExperiment].
.summarized_experiment <- function(
    sparse_counts,
    col_data,
    row_data,
    metadata = NULL) {
    message("Packaging SummarizedExperiment")

    # Metadata ====
    # Coerce to [SimpleList], if necessary
    if (!is.null(metadata) & class(metadata) != "SimpleList") {
        metadata <- as(metadata, "SimpleList")
    }


    # colData ====
    col_data <- col_data[colnames(sparse_counts), ]
    rownames(col_data) <- colnames(sparse_counts)


    # rowData ====
    row_data <- row_data[rownames(sparse_counts), ]
    rownames(row_data) <- rownames(sparse_counts)


    # Return [SummarizedExperiment] ====
    SummarizedExperiment(
        assays = SimpleList(
            sparse_counts = sparse_counts),
        colData = col_data,
        rowData = row_data,
        metadata = metadata)
}
